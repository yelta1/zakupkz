<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Анализатор цен товаров</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      background: linear-gradient(90deg, #2563eb 60%, #60a5fa 100%);
      color: #fff;
      padding: 20px 0 16px 0;
      margin-bottom: 32px;
      box-shadow: 0 4px 16px #0002;
      border-radius: 0 0 18px 18px;
    }
    h1 {
      margin: 0;
      font-size: 2.2rem;
      letter-spacing: 1px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    h2 {
      margin-top: 32px;
      margin-bottom: 12px;
      font-size: 1.3rem;
      font-weight: 600;
    }
    .btn {
      background: linear-gradient(90deg, #2563eb 60%, #60a5fa 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      cursor: pointer;
      margin: 4px 0;
      font-weight: 500;
      font-size: 1rem;
      box-shadow: 0 2px 8px #2563eb22;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn svg { vertical-align: middle; }
    .btn:hover, .btn:focus {
      background: linear-gradient(90deg, #1d4ed8 60%, #3b82f6 100%);
      box-shadow: 0 4px 16px #2563eb33;
      transform: translateY(-2px) scale(1.03);
    }
    .btn-secondary {
      background: #e0e7ff;
      color: #2563eb;
      border: 1px solid #c7d2fe;
      box-shadow: none;
    }
    .btn-secondary:hover, .btn-secondary:focus {
      background: #c7d2fe;
      color: #1d4ed8;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 24px #2563eb11;
      padding: 20px;
      margin-bottom: 20px;
      transition: box-shadow 0.2s, transform 0.2s;
      animation: popIn 0.3s;
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }
    .card:hover {
      box-shadow: 0 8px 32px #2563eb22;
      transform: translateY(-2px) scale(1.01);
    }
    .card-img {
      width: 90px;
      height: 90px;
      object-fit: cover;
      border-radius: 10px;
      background: #e0e7ff;
      box-shadow: 0 2px 8px #2563eb11;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      color: #c7d2fe;
    }
    .card-content { flex: 1; }
    .flex { display: flex; align-items: center; }
    .flex-between { display: flex; align-items: center; justify-content: space-between; }
    .supplier-item {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 10px 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-left: 4px solid #2563eb33;
      transition: background 0.2s;
      animation: fadeIn 0.3s;
    }
    .supplier-item:hover {
      background: #e0e7ff;
    }
    .price-analysis {
      background: #e0e7ff;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
      color: #1e40af;
      font-size: 1rem;
      box-shadow: 0 2px 8px #2563eb11;
      animation: fadeIn 0.3s;
    }
    .text-center { text-align: center; }
    .text-gray { color: #6b7280; }
    .hidden { display: none !important; }
    input, select, textarea {
      border: 1.5px solid #c7d2fe;
      border-radius: 8px;
      padding: 10px;
      margin: 4px 0 14px 0;
      font-size: 1rem;
      background: #f8fafc;
      transition: border 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border: 1.5px solid #2563eb;
      outline: none;
      box-shadow: 0 0 0 2px #2563eb33;
    }
    input[type="number"] { width: 70px; }
    label { display: block; margin-bottom: 2px; font-weight: 500; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-4 { margin-bottom: 16px; }
    .modal-bg {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(30,64,175,0.12);
      display:flex; align-items:center; justify-content:center; z-index:10;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal {
      background:#fff;
      border-radius:14px;
      padding:28px;
      min-width:320px;
      max-width:95vw;
      box-shadow: 0 8px 32px #2563eb22;
      animation: popIn 0.25s;
    }
    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .alert {
      position: fixed;
      top: 24px;
      right: 24px;
      background: #22c55e;
      color: #fff;
      padding: 16px 28px;
      border-radius: 10px;
      font-size: 1.1rem;
      box-shadow: 0 4px 24px #22c55e33;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: fadeIn 0.3s;
    }
    .alert svg { vertical-align: middle; }
    .img-upload {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .img-upload input[type="file"] {
      border: none;
      background: none;
      padding: 0;
      margin: 0;
    }
    .img-preview {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      background: #e0e7ff;
      box-shadow: 0 2px 8px #2563eb11;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #c7d2fe;
    }
    ::-webkit-scrollbar { width: 8px; background: #e0e7ff; }
    ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 8px; }
    @media (max-width:600px) {
      .container { padding: 4px; }
      .modal { min-width: 0; }
      h1 { font-size: 1.3rem; }
      .card { flex-direction: column; align-items: stretch; }
      .card-img { margin-bottom: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container flex-between">
      <h1>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
        Анализатор цен товаров
      </h1>
      <div>
        <button id="tab-products" class="btn btn-secondary"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Товары</button>
        <button id="tab-cart" class="btn btn-secondary"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path></svg>Корзина <span id="cart-count">0</span></button>
      </div>
    </div>
  </header>
  <main class="container">
    <section id="products-section">
      <div class="flex-between mb-4">
        <h2>Товары</h2>
        <button id="add-product-btn" class="btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>Добавить товар</button>
      </div>
      <div id="products-list"></div>
      <div id="products-empty" class="text-center text-gray mt-4">Нет товаров. Добавьте первый товар.</div>
    </section>
    <section id="cart-section" class="hidden">
      <h2>Корзина</h2>
      <div id="cart-list"></div>
      <div id="cart-empty" class="text-center text-gray mt-4">Корзина пуста.</div>
    </section>
  </main>
  <div id="modal-bg" class="modal-bg hidden">
    <div class="modal">
      <h2>Добавить товар</h2>
      <form id="product-form" autocomplete="off">
        <label>Название *</label>
        <input type="text" id="product-name" required>
        <label>Описание</label>
        <textarea id="product-desc"></textarea>
        <label>Категория</label>
        <input type="text" id="product-cat">
        <div class="img-upload">
          <input type="file" id="product-img" accept="image/*">
          <div id="img-preview" class="img-preview"></div>
        </div>
        <div class="mt-2 mb-2"><b>Поставщики *</b></div>
        <div id="suppliers-list"></div>
        <div class="flex-between mb-2">
          <input type="text" id="supplier-name" placeholder="Поставщик" style="width:30%">
          <input type="number" id="supplier-price" placeholder="Цена" style="width:20%">
          <select id="supplier-currency" style="width:20%">
            <option value="₽">₸</option>
            <option value="$">$</option>
            <option value="€">€</option>
          </select>
          <button type="button" id="add-supplier-btn" class="btn" style="padding:4px 10px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg></button>
        </div>
        <textarea id="supplier-notes" placeholder="Заметки (необязательно)"></textarea>
        <div class="flex-between mt-4">
          <button type="button" id="cancel-btn" class="btn btn-secondary">Отмена</button>
          <button type="submit" class="btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>Добавить товар</button>
        </div>
      </form>
    </div>
  </div>
  <div id="alert" class="alert hidden"></div>
  <script>
    // --- State ---
    let cart = [];
    let suppliers = [];
    let productImgData = '';
    let currentProductId = null;
    // --- Elements ---
    const productsSection = document.getElementById('products-section');
    const cartSection = document.getElementById('cart-section');
    const tabProducts = document.getElementById('tab-products');
    const tabCart = document.getElementById('tab-cart');
    const cartCount = document.getElementById('cart-count');
    const alertBox = document.getElementById('alert');
    // --- Tabs ---
    tabProducts.onclick = () => {
      productsSection.classList.remove('hidden');
      cartSection.classList.add('hidden');
      tabProducts.classList.remove('btn-secondary');
      tabCart.classList.add('btn-secondary');
    };
    tabCart.onclick = () => {
      productsSection.classList.add('hidden');
      cartSection.classList.remove('hidden');
      tabCart.classList.remove('btn-secondary');
      tabProducts.classList.add('btn-secondary');
      renderCart();
    };
    // --- Modal ---
    const modalBg = document.getElementById('modal-bg');
    const addProductBtn = document.getElementById('add-product-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    addProductBtn.onclick = () => { showModal(); };
    cancelBtn.onclick = () => { hideModal(); };
    function showModal() {
      modalBg.classList.remove('hidden');
      document.getElementById('product-form').reset();
      suppliers = [];
      productImgData = '';
      renderSuppliersList();
      document.getElementById('img-preview').innerHTML = '';
    }
    function hideModal() {
      modalBg.classList.add('hidden');
    }
    // --- Image upload ---
    const imgInput = document.getElementById('product-img');
    const imgPreview = document.getElementById('img-preview');
    imgInput.onchange = function(e) {
      const file = e.target.files[0];
      if (!file) { productImgData = ''; imgPreview.innerHTML = ''; return; }
      const reader = new FileReader();
      reader.onload = function(ev) {
        productImgData = ev.target.result;
        imgPreview.innerHTML = `<img src="${productImgData}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;">`;
      };
      reader.readAsDataURL(file);
    };
    // --- Suppliers in Modal (local, до отправки товара) ---
    const addSupplierBtn = document.getElementById('add-supplier-btn');
    addSupplierBtn.onclick = () => {
      const name = document.getElementById('supplier-name').value.trim();
      const price = parseFloat(document.getElementById('supplier-price').value);
      const currency = document.getElementById('supplier-currency').value;
      const url = '';
      const notes = document.getElementById('supplier-notes').value.trim();
      if (name && price > 0) {
        suppliers.push({ name, price, currency, url, notes });
        document.getElementById('supplier-name').value = '';
        document.getElementById('supplier-price').value = '';
        renderSuppliersList();
      }
    };
    function renderSuppliersList() {
      const list = document.getElementById('suppliers-list');
      list.innerHTML = '';
      suppliers.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'supplier-item';
        div.innerHTML = `<span>${s.name} — ${s.price} ${s.currency}</span><button onclick="window.removeSupplier(${i})" title="Удалить"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button>`;
        list.appendChild(div);
      });
    }
    window.removeSupplier = function(i) {
      suppliers.splice(i,1); renderSuppliersList();
    }
    // --- Add Product (POST to API, then POST suppliers) ---
    document.getElementById('product-form').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('product-name').value.trim();
      if (!name || suppliers.length === 0) {
        showAlert('Заполните название и добавьте хотя бы одного поставщика!', false);
        return;
      }
      const desc = document.getElementById('product-desc').value.trim();
      const cat = document.getElementById('product-cat').value.trim();
      // 1. Добавляем товар
      let productId = null;
      try {
        const res = await fetch('http://localhost:8080/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            description: desc,
            category: cat,
            image_url: productImgData
          })
        });
        const data = await res.json();
        if (!data.id) throw new Error('Ошибка добавления товара');
        productId = data.id;
      } catch (err) {
        showAlert('Ошибка добавления товара!', false);
        return;
      }
      // 2. Добавляем поставщиков
      for (const s of suppliers) {
        try {
          await fetch(`http://localhost:8080/products/${productId}/suppliers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(s)
          });
        } catch (err) {
          showAlert('Ошибка добавления поставщика!', false);
        }
      }
      hideModal();
      await loadProducts();
      showAlert('Товар успешно добавлен!', true);
    };
    // --- Load products from API ---
    async function loadProducts() {
      const list = document.getElementById('products-list');
      const empty = document.getElementById('products-empty');
      list.innerHTML = '<div class="text-center text-gray">Загрузка...</div>';
      let products = [];
      try {
        const res = await fetch('http://localhost:8080/products');
        products = await res.json();
      } catch (err) {
        list.innerHTML = '<div class="text-center text-gray">Ошибка загрузки товаров</div>';
        return;
      }
      list.innerHTML = '';
      if (products.length === 0) { empty.classList.remove('hidden'); return; } else { empty.classList.add('hidden'); }
      for (const product of products) {
        // Получаем поставщиков для каждого товара
        let productSuppliers = [];
        try {
          const res = await fetch(`http://localhost:8080/products/${product.id}/suppliers`);
          productSuppliers = await res.json();
        } catch {}
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-img">${product.image_url ? `<img src="${product.image_url}" style="width:90px;height:90px;object-fit:cover;border-radius:10px;">` : `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#c7d2fe" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>`}</div>
          <div class="card-content">
            <div class="flex-between mb-2">
              <div><b>${product.name}</b><br><span class="text-gray">${product.description||''}</span><br><span class="text-gray">${product.category||''}</span></div>
              <div class="flex" style="gap:8px;">
                <button class="btn btn-secondary" onclick="window.toggleAnalysis('${product.id}')" title="Анализ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 17.35c0 2.13-2.08 2.85-2.08 2.85"></path></svg></button>
                <button class="btn btn-secondary" onclick="window.deleteProduct('${product.id}')" title="Удалить"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button>
              </div>
            </div>
            <div id="analysis-${product.id}" class="price-analysis hidden"></div>
            <div class="mt-2">
              <label>Поставщик:</label>
              <select id="supplier-${product.id}"><option value="">Выберите</option>${productSuppliers.map(s=>`<option value="${s.id}">${s.name} — ${s.price} ${s.currency}</option>`).join('')}</select>
              <div id="selected-supplier-${product.id}" class="hidden mt-2">
                <span id="selected-name-${product.id}"></span> — <span id="selected-price-${product.id}"></span>
                <input type="number" min="1" value="1" id="quantity-${product.id}" style="width:60px; margin-left:8px;">
                <button class="btn" onclick="window.addToCart('${product.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path></svg>В корзину</button>
              </div>
            </div>
          </div>
        `;
        list.appendChild(card);
        // Анализ цен
        const analysisDiv = card.querySelector(`#analysis-${product.id}`);
        card.querySelector(`button[onclick*='toggleAnalysis']`).onclick = () => {
          if (analysisDiv.classList.contains('hidden')) {
            const prices = productSuppliers.map(s=>s.price);
            if (prices.length === 0) {
              analysisDiv.innerHTML = 'Нет поставщиков';
            } else {
              const min = Math.min(...prices);
              const max = Math.max(...prices);
              const avg = (prices.reduce((a,b)=>a+b,0)/prices.length).toFixed(2);
              analysisDiv.innerHTML = `<b>Лучшая цена:</b> ${min}<br><b>Максимальная:</b> ${max}<br><b>Средняя:</b> ${avg}<br><b>Поставщиков:</b> ${productSuppliers.length}`;
            }
            analysisDiv.classList.remove('hidden');
          } else {
            analysisDiv.classList.add('hidden');
          }
        };
        // Поставщик и корзина
        const select = card.querySelector(`#supplier-${product.id}`);
        const selDiv = card.querySelector(`#selected-supplier-${product.id}`);
        select.onchange = function() {
          const val = select.value;
          if (!val) { selDiv.classList.add('hidden'); return; }
          const s = productSuppliers.find(s=>s.id==val);
          card.querySelector(`#selected-name-${product.id}`).textContent = s.name;
          card.querySelector(`#selected-price-${product.id}`).textContent = s.price + ' ' + s.currency;
          selDiv.classList.remove('hidden');
        };
        // Добавление в корзину
        window.addToCart = function(productId) {
          const product = products.find(p=>p.id==productId);
          const supplierId = card.querySelector(`#supplier-${productId}`).value;
          const quantity = parseInt(card.querySelector(`#quantity-${productId}`).value)||1;
          if (!supplierId) return;
          const supplier = productSuppliers.find(s=>s.id==supplierId);
          cart.push({ product, supplier, quantity });
          cartCount.textContent = cart.length;
          showAlert('Товар добавлен в корзину!', true);
        };
      }
    }
    window.toggleAnalysis = function(id){}; // заглушка, заменяется в renderProducts
    // --- Render Cart (локально) ---
    function renderCart() {
      const list = document.getElementById('cart-list');
      const empty = document.getElementById('cart-empty');
      list.innerHTML = '';
      if (cart.length === 0) { empty.classList.remove('hidden'); return; } else { empty.classList.add('hidden'); }
      let total = 0;
      cart.forEach((item, i) => {
        total += item.supplier.price * item.quantity;
        const div = document.createElement('div');
        div.className = 'supplier-item';
        div.innerHTML = `<span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg> ${item.product.name} — ${item.supplier.name}</span><span>${item.supplier.price} ${item.supplier.currency} × ${item.quantity} = <b>${item.supplier.price*item.quantity} ${item.supplier.currency}</b></span><button onclick="window.removeFromCart(${i})" title="Удалить"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button>`;
        list.appendChild(div);
      });
      const totalDiv = document.createElement('div');
      totalDiv.className = 'mt-4';
      totalDiv.innerHTML = `<b>Итого: ${total}</b>`;
      list.appendChild(totalDiv);
    }
    window.removeFromCart = function(i) {
      cart.splice(i,1); cartCount.textContent = cart.length; renderCart();
    };
    // --- Alert ---
    function showAlert(msg, success=true) {
      alertBox.innerHTML = success ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg> ${msg}` : `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg> ${msg}`;
      alertBox.classList.remove('hidden');
      setTimeout(()=>alertBox.classList.add('hidden'), 1800);
    }
    // --- Delete Product ---
    window.deleteProduct = async function(productId) {
      if (!confirm('Удалить этот товар?')) return;
      try {
        await fetch(`http://localhost:8080/products/${productId}`, { method: 'DELETE' });
        showAlert('Товар удалён!', true);
        await loadProducts();
      } catch (err) {
        showAlert('Ошибка удаления товара!', false);
      }
    }
    // --- Init ---
    productsSection.classList.remove('hidden');
    cartSection.classList.add('hidden');
    modalBg.classList.add('hidden');
    loadProducts();
    renderCart();
  </script>
</body>
</html> 